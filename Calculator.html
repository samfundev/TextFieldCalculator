<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="initial-scale=1">
		<link rel="icon" href="favicon.ico">
		<title>Text-Field Calculator</title>
		<link rel="stylesheet" href="main.css">
		<script src="jquery-3.6.0.min.js"></script>
		<script src="https://unpkg.com/mathjs@13.0.0/lib/browser/math.js"></script>
		<script>
			function getType(o) {
				return Object.prototype.toString.call(o).match(/^\[object\s(.*)\]$/)[1].toLowerCase();
			}

			function insert(base, pos, insert) {
				return base.substr(0, pos) + insert + base.substr(pos)
			}

			// https://stackoverflow.com/a/6234804/8213163
			function escapeHtml(unsafe) {
				return unsafe
					.replace(/&/g, "&amp;")
					.replace(/</g, "&lt;")
					.replace(/>/g, "&gt;")
					.replace(/"/g, "&quot;")
					.replace(/'/g, "&#039;");
			}

			math.config({
				number: "BigNumber",
				precision: 32
			});

			// Extra functions
			math.import({
				divmod: (x, n) => math.matrix([Math.floor(x / n), x % n]),
				signatures: (f) => f.signatures,
			});

			$(function() {
				var output = $(".output");
				var input = $(".input");

				input.val(localStorage.getItem("content") ?? "");

				function evaluateInput() {
					var expression = input.val();
					var result;
					try {
						result = math.evaluate(expression);
					} catch(e) {
						result = e;
					}

					var type = getType(result);

					if (type == "error") {
						var position = result.char;
						if (position) {
							const escaped = escapeHtml(expression);
							const column = position - escaped.lastIndexOf("\n", position - 1) - 2;
							const endOfLine = escaped.indexOf("\n", position) == -1 ? escaped.length : escaped.indexOf("\n", position);
							const escapedMessage = escapeHtml(result.message);
							const message = escapedMessage.substring(0, escapedMessage.length - ` (char ${position})`.length);
							output.html(insert(escaped, endOfLine + 1, `<div class='error'>${' '.repeat(column)}^ ${message}</div>`));
						} else {
							output.html($("<div>").addClass("error").text(result.message));
						}
					} else {
						if (result === undefined) {
							result = "";
						} else if (result.type === "ResultSet") {
							result = result.entries.map(entry => math.format(entry, { notation: "fixed" })).join("\n");
						} else {
							result = math.format(result, { notation: "fixed" });
						}

						output.text(result);
					}


					// Put text in localStorage to persist data
					localStorage.setItem("content", expression);
				}

				input.on("input", function(e) {
					evaluateInput();
				}).on("keydown", function(e) {
					if (e.key == "Tab") {
						if (!output.hasClass("error")) {
							input.select();

							var text = output.text();
							if (!document.execCommand("insertText", false, text))
							{
								input[0].setRangeText(text, 0, input[0].selectionEnd, "end");
							}
						}
						return false;
					}
				});

				evaluateInput();
			})
		</script>
		<style>
			body {
				display: flex;
				flex-direction: column;
				min-height: calc(100vh - 20px);

				margin: 10px;
			}

			.input {
				width: 100%;
				box-sizing: border-box;
				height: 30vh;
				resize: vertical;
				margin-bottom: .5em;
				font-size: inherit;
			}

			.output {
				font-family: monospace;
				white-space: pre-wrap;
			}

			.error {
				color: rgb(255, 50, 50);
			}
		</style>
	</head>
	<body>
		<header>
			<b>Text-Field Calculator</b>
			<a href="Calculator-v2.html">Version 2</a>
		</header>
		<textarea class="input" autofocus></textarea>
		<div class="output-wrap">
			<div style="font-weight: bold;">Output:</div><div class="output"></div>
		</div>
		<footer>
			<a href="https://mathjs.org/docs/index.html#documentation">Documentation</a>
			<a href="https://github.com/samfundev/TextFieldCalculator">Source</a>
		</footer>
	</body>
</html>